"use strict";function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function LoggerForCannotDuplicate(e){e||(e={});var t=this;function n(){if(t.preQueue.length)return t[t.preQueue[0].name](t.preQueue[0].loggerContent).then(function(){if(t.preQueue.shift(),t.preQueue.length)return n()})}if(this.db=null,this.preQueue=[],this.runVersionChange=!1,"[object Object]"!==Object.prototype.toString.call(e))throw new Error("loggerForCannotDuplicate: config must be an object or empty");this.userConfig=e,this.userConfig.collectionName="string"==typeof this.userConfig.collectionName?this.userConfig.collectionName:"default",this.userConfig.serverAddr="string"==typeof this.userConfig.serverAddr?this.userConfig.serverAddr:"https://api.zhoushoujian.com/error_log","https://api.zhoushoujian.com/error_log"===this.userConfig.serverAddr&&console.warn("server addr is not config, will use mock addr instead!");var o=this.userConfig.collectionName,r=indexedDB.open(o,1);r.onerror=function(e){console.error("loggerForCannotDuplicate: 数据库打开报错")},r.onsuccess=function(e){t.db=r.result,setTimeout(function(){t.runVersionChange||n()},50)},r.onupgradeneeded=function(e){t.runVersionChange=!0,t.db=e.target.result,t.db.createObjectStore("collection",{keyPath:"key"}),setTimeout(function(){n()},10)},this.add=function(e){return t.db?(e={key:(new Date).formatTime("yyyy-MM-dd hh:mm:ss:S")+"-"+String(Math.random()).slice(-4),content:e},new Promise(function(n){var o=t.db.transaction(["collection"],"readwrite").objectStore("collection").add(e);o.onsuccess=function(t){n(e)},o.onerror=function(e){n(e),console.warn("loggerForCannotDuplicate: 数据写入失败")}})):(t.preQueue.push({name:"add",loggerContent:e}),Promise.resolve("pending"))},this.read=function(){if(!t.db)return t.preQueue.push({name:"read"}),Promise.resolve("pending");var e=[];return new Promise(function(n){t.db.transaction("collection").objectStore("collection").openCursor().onsuccess=function(t){var o=t.target.result;o?(e.push(o.value),o.continue()):n(e)}})},this.remove=function(){return t.db?new Promise(function(e){t.db.close();var n=indexedDB.deleteDatabase(o);n.onsuccess=function(){e("success")},n.onerror=function(){console.log("Couldn't delete database"),e("fail")},n.onblocked=function(){e("blocked")}}):(t.preQueue.push({name:"remove"}),Promise.resolve("pending"))},this.send=function(e,n){function o(e,o){var r=new XMLHttpRequest;r.open("POST",t.userConfig.serverAddr,!0),r.setRequestHeader("Content-Type","application/json;charset=UTF-8"),r.onreadystatechange=function(){4===r.readyState&&200===r.status?o(r.responseText):o("send_fail")};var i={loggerContents:e};n&&(i=_defineProperty({logger:e},n,!0)),r.send(JSON.stringify(i))}return new Promise(function(n){e?o(e,n):t.read().then(function(e){o(e,n)})})}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0,Date.prototype.formatTime=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var n in/(y+)/.test(e)&&(e=e.replace(RegExp.$1,this.getFullYear().substr(4-RegExp.$1.length))),t)new RegExp("("+n+")").test(e)&&(e=e.replace(RegExp.$1,1===RegExp.$1.length?t[n]:("00"+t[n]).substr(t[n].length)));return e};var _default=LoggerForCannotDuplicate;exports.default=_default;